# Writing Hub Plugins

This section provides instructions on how to write a plugin for use with the WoST Hub. 


> ## Under Development
> This document is under development



## Starting And Stopping Plugins

Plugins are launched by the Hub and passed the same commandline parameters used to start the Hub itself. These commandline parameters can be used to determine the location of configuration files, certificates and log files.

Commandline options:
```
-c file.yaml           Use this configuration file instead of the default config/hub.yaml
 
--home=path            Set the application working directory. Default is parent of the executable 

--certFolder=path      Set a different TLS certificate folder. Default is ./certs

--configFolder=path    Set a different config folder. Default is ./config

--hostname=dnsname|ip  Message bus address host:port". Default is localhost:9678

--logFile=path         Write log message to this file. Default is ./logs/{pluginID}.log

--protocol=name        Message bus protocol: internal|mqtt

--pluginFolder=path    Alternate plugin folder. Empty to not load plugins.

--logLevel=level       Set loglevel to one of: error|warning|info|debug. Default is warning
```

Upon startup, a plugin reads the commandline to determine the configuration file and read the hub.yaml and plugin configuration. A library to do this in a single line is included in the "hubconfig" package of the hubapi-go repository.

After loading the configuration, plugins connect to the message bus as a plugin using client certificates for authentication. The message bus address and certificate folder are configured in the config/hub.yaml configuration file.

The 'hubclient.NewPluginClient' function makes it easy to connect to the bus and deal with the certificate boilerplate. 

Last, run the plugin service in a separate process and wait for the SIGTERM signal to end the service.

In summary:

```golang
  import "github.com/wostzone/hubapi/pkg/hubconfig"
  import "github.com/wostzone/hubapi/pkg/hubclient"

  const PluginID = "my-plugin"
  pluginConfig := MyPluginConfig{}

  hubConfig, err := hubconfig.LoadCommandlineConfig("", PluginID, &pluginConfig)
  client := hubclient.NewPluginClient(clientID, hubConfig)
  err := client.Start()
  if err != nil {
    exit(1)
  }

  // Run the plugin
  go myPluginService(client, hubConfig, &pluginConfig)

  // wait for the SIGTERM signal to end
	hub.WaitForSignal()

  // cleanup code goes here if neccesary
```

(note: the API is still subject to change)

The provided client libraries in hubapi-go implement the connection logic for the various protocols using the configuration from hubconfig. Next, the plugin can use the Client API to receive, send or update TDs, send and receive events and action messages.


## Authentication

Plugins authenticate using a client certificate. The location of this certificate is in the hub's certs folder defined in hub.yaml. Only the WoST process that runs the plugin has read access to the client certificate and corresponding private key. These are generated by the hub using the CA certificate in the same folder. All plugins use the same client certificate.

The NewPluginClient function handles the loading of the CA and client certificates and connects to the MQTT broker. In short, no need to do anything. You can write your own version if this if desired. The code should be self explanatory to developers.


## Stopping The Plugin

When the Hub terminates it stops each plugin in turn using a SIGTERM signal.
The plugin should close connections and exit with result code 0.



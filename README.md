# WoST Gateway

The WoST Gateway is the reference implementation of the gateway for the Web of Secured Things. It receives information from 'WoST Things' and makes the result available to consumers. The gateway aims to be compatible with the WoT open standard but is constrainted to features that meet the WoST security mandate of "Things Do Not Run Servers".

## Project Status

Status: Pre-Alpha

The core implementation of the gateway is feature complete. This includes a built-in message bus and the option to use MQTT as a message bus to communicate between plugins and gateway. The gateway can be started and will listen for publication and subscriptions by plugins

Next up is adding an example plugin 


## Audience

This project is aimed at software developers and system implementors with knowledge of operating systems and computing devices. 

A Binary distribution of the gateway and its plugins can be installed and used by users with basic Linux skills.

## Summary

The gateway is intended to cover various use-cases. The WoT architecture describes [several of them](https://www.w3.org/TR/wot-architecture/#sec-use-cases) such as smart home for consumers and smart factories in industry. 

The gateway is intended to be used with WoST compliant IoT devices (WoST Things)and legacy devices. WoST compliant devices automatically discovery the gateway on a local network and requests to provision themselves. The administrator logs into the gateway and accepts the provisioning request. From then on the device sends its data to the gateway from where it can be accessed and monitored. A management plugin lets the user administer and monitor devices through a web browser. 

Legacy devices that are not WoST compliant are accessed through plugins that convert between the legacy format and WoT standards. They can be used as if they are WoT devices via the gateway APIs.

In either case IoT devices never access the Internet directly. WoST managed IoT devices should remain in a secured fire-walled area. End users view and control the devices through the gateway using their web browser. This works entirely stand-alone and no Internet access is required. For remote access and monitoring, the gateway can connect securely to a cloud WoST Gateway over the Internet. Here too, there is never a direct connection from the Internet to the local network.

The features of the gateway is provided through plugins. Core plugins that (will be) included are for Thing discovery using Thing Description documents. 

## Installation

The WoST Gateway is designed to run on Linux based computers. Mac, Windows and Android versions are currently not considered since the recommendation is to run it on a stand-alone computer. 

### System Requirements

Unless the gateway is provided as part of an appliance, it needs to be installed on a computer. It is best to use a dedicated computer for this. 

For home users a raspberry pi 2+ will be powerful enough to run the gateway and simple plugins. For industrial or automotive usage a dedicated embedded computer system is recommended.

In its most basic configuration the gateway needs less than 100MB of RAM and an ARMv7 CPU as found on a PI2. See plugin documentation for additional memory requirements.

### Install From Package Manager

Installation from package managers is currently not available.

### Manual Install To Home

Installation tarballs will be made available or build from source.
After untarring or building go to the 'dist' folder and copy the files to the home's bin folder.
```
mkdir ~/bin/wost
cp -a * ~/bin/wost
```
This will create the following folder structure

* /home/{user}/bin/wost/bin      gateway and plugin binaries
* /home/{user}/bin/wost/config   gateway and plugin configuration
* /home/{user}/bin/wost/logs     gateway and plugin logging output
* /home/{user}/bin/wost/certs    TLS certificates generated by the 
  

### Manual Install To System

For systemd installation, as root for user 'wost'. 
When changing the user and folders make sure to edit the wost-gateway.service file accordingly.
From the dist folder run:
```
# Create folders
mkdir /opt/wost/       
mkdir /etc/wost/       
mkdir /etc/wost/certs/ 
mkdir /var/log/wost/   

# Install WoST configuration and systemd
cp config/* /etc/wost
cp wost-gateway.service /etc/systemd/system

# Setup user and permissions
adduser --system --no-create-home --home /opt/wost --shell /usr/sbin/nologin --group wost
chown -R wost:wost /etc/wost
chown -R wost:wost /var/log/wost

systemctl daemon-reload
```

### Build From Source

To build the core and bundled plugins from source, a Linux system with golang and make tools must be available. 3rd party plugins are out of scope for these instructions and can require nodejs, python and golang.

Prerequisites:
1. Golang 1.14 or newer
2. GCC Make

Build and install from source (tentative):
```
$ git clone https://github.com/wostzone/gateway
$ make clean             # clean any prior builds 
$ make bin               # Intel x64 binary
$ make arm               # Arm binary
```

After the build is complete, the distribution binaries can be found in the 'dist' folder. 

## Configuration

The gateway is configured through the 'gateway.yaml' configuration file that can be edited with a regular text editor. The sample file in the dist config folder contains configuration options with the default values.

The gateway looks in the ./config folder or the /etc/wost folder for this file. This file is optional. Out of the box defaults will provide a working gateway with an internal service bus that listens on localhost port 9678 (WOST). 

Plugins can optionally be configured through yaml configuration files in the same configuration folder.

## Launching

The gateway can be launched manually by invoking the 'gateway' app in the wost folder.
eg ~/bin/wost/bin/gateway

A systemd launcher can be configured to launch automatically on startup for Linux systems that use systemd.

```
systemctl enable wost-gateway
systemctl start wost-gateway
```

# Design 

![Design Overview](./docs/gateway-design.png)

## Overview

The gateway consists of an internal service bus and a collection of plugins. The plugins fall into two categories, protocol bindings and services. Protocol bindings connect with Things and 3rd party IoT devices while services provide consumer side functionality such as directory services. When available the WoT specified data and API definitions are used.

All features of the gateway are provided through these plugins. Plugins can be written in any language, including ECMAScript to be compliant with the [WoT Scripting API](https://www.w3.org/TR/wot-architecture/#sec-scripting-api). It is even possible to write a plugin for plugins to support a particular programming platform such as EC6. 

As mentioned, plugins fall into two categories depending on their purpose:
* Protocol bindings provide connectivity for WoST Things and for 3rd party protocols. These plugins convert the device description data they receive to a Thing Description document and submit events in the WoT format according to the WoT specifications.
* Service plugins typically subscribe to Thing updates to provide a service to client applications. They can also publish actions for Things to execute. Services can make additional API's available to consumers, for example a directory service and a web client interface.

The gateway comes with an internal websocket based lightweight message bus for communication between plugins and gateway. A client library is provided for plugins to easily publish and subscribe to messages. The message bus is default configured for TLS and generates its own CA, Server and Client certificates. For those that think this is overkill, TLS can be disabled with the useTLS option set to false. When run without configuration the gateway will start the internal message bus with TLS. 

For high performance use-cases the internal message bus can be replaced with a MQTT based service such Mosquitto. To enable this set the 'protocol' option to 'mqtt' in the configuration file and the hostname to the address and port of the MQTT server.

The included gateway client library support both the internal message bus and MQTT. This allows the re-use of a plugin in places with different message bus implementations. The gateway client library will be made available for programming language such as golang, ES6, and Python. 

Plugins publish and subscribe to gateway 'channels'. Each type of data has its own channel. WoT related channel are the 'td', 'events' and 'actions' channels. That carry JSON messages in the WoT specified format. Plugins can add additional channels as needed.


## Protocol Binding Plugins

The primary role of protocol binding plugins is to translate between the WoT data formats and the legacy protocol. This involves the respective 3 channels 'td', 'events', and 'actions'.

The format of the data pushed into the channel MUST match the schema associated with the channel ID. Schemas are defined in the JSON-LD format as defined in schema.org, WoT schemas, and NGSI-LD schemas. 

For example, the schema for the [Thing Description](https://www.w3.org/TR/wot-thing-description/#behavior-data) is descripted in the [TD Schema](https://www.w3.org/TR/wot-thing-description/#json-schema-for-validation)

See the 'writing a plugin' (todo) documentation or one of the existing plugins on how to use channels to communicate with the gateway.

## Service Plugins

Service plugins consume channel data for further use. They can provide their own API or run their own web server to make this data available to consumers. For example a directory service provides an API to query known devices. The admin plugin provides a web page to administer the gateway and its plugins.

Service plugins can also create a new channel to communicate with other plugins, specific to the purpose of the plugin.

<todo>See the list of available service plugins for details. </todo>

## Writing Plugins

Plugins can be written in any programming language. They can include a configuration file that describes their purpose and the channels they use. Plugins should use the gateway messenger library to connect to the service bus.

There is nearly no boilerplate code involved in writing plugins, except for adhering to the channel data requirements. Plugins can therefore be very lightweight and efficient. 

Plugins run in their own process, isolated from other plugins. It is however possible to write a plugin that launches other plugins in threads. For example, a JS plugin can load additional plugins written in Javascript. Each of the additional plugin connects to the gateway channels using the client library.

### Data Channels

Data published on WoST Gateway channels MUST adhere to that data channel's schema specification.  The Gateway has the following predefined channels:
* td: Thing descriptions https://www.w3.org/TR/2020/WD-wot-thing-description11-20201124/
* events: Thing events
* action: Thing actions

Message published on these channel MUST adhere to the WoT data schemas for TD, events and actions.

### Reference Plugins

The WoST project plans to include several plugins for working out of the box.

* The 'smbus' plugin is a simple message bus for out of the box secure plugin to gateway communication.

* The 'discovery' protocol binding announces the gateway on the local network using mDNS. This is intended to let WoST Things discover the gateway.

* The  'wost' protocol binding provides a websocket API for use by WoST Things to provision, publish TD's, publish events, and receive actions.

* The 'recorder' service records channel messages into files. Intended for testing.
 
* The 'directory' service plugin provides an HTTPS API for consumers to query provisioned and discovered Things. 

Advanced plugins that are planned:

* The 'intermediary' service plugin forwards TD and events from exposed Things to a remote gateway or intermediary, and optionally receive actions. This is intended for cloud based access to Things.

* The 'history' service plugin implements the history API to query historical values for Things. (NGSI-LD history API)

* The 'script' service plugin executes ECMA scripts. It lets script receive channel data and can execute actions. 

* The 'notification' service plugin sends messages from the notification channel to the configured destination, eg Email, SMS, other.

* The 'admin' service plugin provides a simple web based interface to view and manage Things. 

* The 'wallpaper' service builds a live wallpaper out of ip cameras or other published images

Plugins for connecting to legacy IoT devices

* The 'owserver' protocol binding publishes 1-wire OwServer-V2 devices

* The 'openzwave' protocol binding publishes open-zwave devices

* The 'ipcam' protocol binding publishes network camera snapshots

* The 'isy99' protocol binding publishes ISY99 (Insteon) devices 

All of these plugins can be substituted by another implementation as needed. 


## Launching Plugins

Plugins are launched at startup and given three arguments: 

TBD: either gateway load config or pass params ...
* {host} containing the IP and port of the service bus connection.
* {certFolder} certificate folder for server and client certificates
* {configFile} containing the path to the plugin YAML configuration file. This file is optional. If possible plugins should function out of the box without configuration.

## Messenger Connections

After launch, plugins connect to the message bus and subscribe to channels. The default connect address for the internal service bus (smbus) is:
> wss://{host:port}/wost

Where:
* {host:port} is passed on startup

While a plugin can publish and subscribe to as many channels as needed it is strongly recommended to adhere to the single responsibility principle and only use the channels that are needed to fulfil that responsibility. 

The provided client libraries implement the connection logic for the various protocols so the plugin developer only need to know the channel ID.

A plugin can implement its own connection client for publishing and subscribing. The message format for the built-in websocket message bus is: 
> {command}:{channel}:{payload}
Where command is one of 'publish', 'subscribe', 'unsubscribe', and 'receive'. See wost/gateway/src/msgbus/MsgBusClient.go for more info.


# Contributing

Contributions to WoST projects are always welcome. There are many areas where help is needed, especially with documentation and building plugins for IoT and other devices. See [CONTRIBUTING](docs/CONTRIBUTING.md) for guidelines.


# Credits

This project builds on the Web of Things (WoT) standardization by the W3C.org standards organization. For more information https://www.w3.org/WoT/


# cert service

## Objective

Manage certificates for authentication of hub services, IoT devices and inter-domain hub services.

This service manages the Hub certificates, including a Hub self-signed CA, Hub server certificate and hub service client certificates. The certificates are intended for machine-to-machine authentication of hub services and IoT devices. Users are authenticated using tokens and outside the scope of this plugin.

See also the hub CLI for the commandline to generate the initial certificate bundle.

## Summary

This service manages authentication certificates for use by services, IoT devices and end-users on the local network:

1. create the Hub CA certificate for generating signed certificates
2. create the Hub service/client certificate for use by Hub services (currently a single server certificate for all Hub services)
3. create IoT device client certificates for use by IoT client authentication as used by the idprov provisioning service. Iot device certificates have a default validity of 30 days and should be renewed by the IoT device with the provisioning service before expiry.

This service support multiple implementations of certificate management. The default implementation is internal using self-signed certificates and has no external dependencies. Additional (future) implementations can include lets-encrypt, and 3rd party certification import.

### Hub CA Certificate

The Hub utilizes a self-signed CA certificate. The Hub CA is an organization certificate and not a domain certificate, intended only for use on the local network (domain is local).

A self-signed CA key and certificate is generated during setup. The CA certificate/key is used to sign all generated server and client certificates. The CA public certificate must be distributed to clients so they can validate the server and client certificates.

It is recommended to import the CA certificate in the browser to avoid unnecessary warnings. This certificate has a default 10 year validity period.

The idprov protocol exports the CA certificate to IoT devices when the device is provisioned. No action is needed for HiveOT compatible IoT devices.

TODO: Support lets-encrypt to generate the certificates.

### Hub Service Certificate

Hub Services use a CA signed server certificate to identify themselves to clients and to connect to other services.

A new Hub server TLS certificate is generated on startup. Hub services that offer API access use this certificate to identify themselves for incoming TLS connections. Currently, all services use the same server certificate from the application 'certs' folder.

### IoT Device Client Certificate

IoT devices that register themselves with the Hub to publish 'Things' receive a client certificate upon registration. This certificate is unique to the device and signed by the CA. See also the 'idprov' service that implements the idprov protocol for issuing these certificates.

By default device certificates have a validity period of 30 days, before which they must be renewed with the idprov service.

IoT Device certificates authenticate the IoT device and authorize it to publish the Thing Description documents of the things it represents, and allow subscription to messages to update the Thing configuration and status. The certificate includes the device ID and type to identify it as an IoT Device.

### Client Authentication Using Certificates

Authentication through client certificates is handled by the TLS protocol itself. A valid client certificate as generated by this service is required in order to make a connection. The certificate CN contains the user or service name, the OU is used to indicate the role in the organization:

* Hub plugins use the hub client certificate to access other Hub services. The Hub plugin certificate contains 'plugin' as the OU which is used to authorize full access.
* IoT devices have the device-ID as the CN and 'iotdevice' as the OU. IoT devices are publishers of things and have access to all Things of which they are the publisher.
* The administrator certificate has their user loginID as the CN and 'admin' as the OU.
* Other clients have their loginID as the CN and 'client' as the OU.

Properly signed certificates are accepted as valid authentication without the need of additional credentials.

## Build and Installation

### Build & Install (tentative)

Run 'make all' to build and 'make install' to install as a user.

See [hub's README.md](https://github.com/hiveot/hub/README.md) for more details on system installation.

## Usage

... todo examples ...

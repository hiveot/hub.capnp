# certs service

## Objective

Manage certificates for authentication of hub services, IoT devices and consumers.

## Summary

This service manages authentication certificates for use by services, IoT devices and end-users on the local network:

1. A self-signed Hub CA certificate for generating signed certificates. This is usually done by the administrator using the CLI or the admin web console if such is included.
2. Hub service certificates for each Hub service
3. IoT device client certificates for each IoT device.

This service currently uses self-signed certificates and has no external dependencies. Support for lets-encrypt and 3rd party certification import are planned for the future.

## Certificate Revocation

When certificates are renewed the old certificate is revoked. Certificate revocation checks are currently not enforced but might be in the future. 


## Hub CA Certificate

By default, the Hub utilizes a self-signed CA certificate, created during first install. This is an organization certificate and not a domain certificate and is only intended for use on the local network (domain is local). Use of a 3rd party generated signing certificate is typically not necessary as the Hub is only using these certificates on the local network to identify local IoT devices and users. 

The CA certificate has a default 2 year validity period. A new CA certificate is generated every year using the same public/private key pair. The new CA certificate then has a year to be automatically distributed to the IoT devices when they renew their own certificate. The period of 2 years can be configured as needed for your on particular situation. 

It is recommended to import the CA certificate in the browser to avoid unnecessary warnings when accessing the Hub. The alternative is to accept the browser warning. 

Future: Support lets-encrypt to generate the service and client certificates.

## Hub Service Certificates

Hub Services use a CA signed certificate to identify themselves to clients and to connect to other services.

A new Hub server TLS certificate along with a public/private key pair is generated by the launcher when the service is (re)started. The launcher is the only service with the capability to generate Service certificates. A restart of the Hub via the launcher therefore automatically renews all certificates of the services.  

The certificate CN contains the service ID, while its OU identifies it as a Hub service.

Service certificates have a 1 year validity period. Before that time the service must be restarted using the launcher.

Future: launcher periodically checks for certificate expiration and restarts the service if it nears expiration.


## IoT Device Certificates

IoT devices that register themselves with the Hub to publish 'Things' receive a client certificate upon registration. This certificate is unique to the device and signed by the CA. See also the 'idprov' service that implements the idprov protocol for issuing these certificates.

By default device certificates have a validity period of 30 days, before which they must be renewed with the idprov service.

IoT Device certificates authenticate the IoT device, authorize it to publish the Thing Description documents of the things it represents, and allow subscription to messages to update the Thing configuration and status. 

The certificate CN contains the device ID, while its OU identifies it as an IoT Device.


## Client Authentication Using Certificates

Consumers can be issued a client certificate so they don't have to login using the login name and password. Authentication through client certificates is handled by the TLS protocol itself. 

The certificate CN contains the user login name while the OU is used to indicate the role in the organization:

By default consumer client certificates have a validity of 1 year, before they must be renewed. The certificate service lets a consumer renew its certificate at any time. 

Properly signed certificates are accepted as valid authentication without the need of additional credentials.


## Build and Installation

This package is built as part of the Hub. 

See [hub's README.md](https://github.com/hiveot/hub/blob/main/README.md) for more details on building and installation.

### Configuration

When launched from the installation folder this service works out of the box without requiring configuration.

Each service has its configuration in the application 'config' directory. This is either the installation folder or the /etc/hiveot/config folder as described in the hub README.md

The following default configuration is used:

* service config: <configfolder>/certs.yaml
* ca certificate: <certsfolder>/caCert.pem and caKey.pem
* service certificates: <certsfolder>/<serviceName>Cert.pem and <serviceName>Key.pem

IoT device certificates and keys are not stored on the Hub.

## Usage

This service is intended to be started by the launcher. For testing purposes a manual startup is also possible. In this case the configuration file can be specified using the -c commandline option. 

This service can be used directly by the CLI. See the CLI for more information.

The service API is defined in its capnproto file. "certs.capnp" 

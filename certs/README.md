# cert service

## Objective

Manage certificates for authentication of Hub services, IoT devices and inter-domain hub services.

This manages the Hub certificates, including the Hub self-signed CA, Hub server certificate and hub service client certificates. The certificates are intended for authentication of its users. 

## Status

The status of this plugin is alpha. It is functional but breaking changes are expected.

## Audience

This project is aimed at IoT developers that value the security and interoperability that WoST brings. WoST Things are more secure than traditional IoT devices as they do not run a server, but instead connect to a Hub to publish their information and receive actions.

## Summary

This Hub service supports certificate based authentication for use by services, IoT devices and end-users on the local network. This module manages:
1. the Hub CA certificate for generating signed certificates
2. the Hub server certificate for use by Hub services (currently a single server certificate for all Hub services)
3. Manage client certificates for use by Hub services (currently a single client certificate for all Hub services)
4. Manage client certificates for use by IoT client authentication as used by the idprov provisioning service


### Hub CA Certificate

The WoST Hub utilizes a self-signed CA certificate. The Hub CA is an organization certificate and not a domain certificate, intended for use on the local network.  

A self-signed CA certificate is generated on first startup. The CA certificate is used to generate server and client certificates. The CA certificate must be distributed to clients so they can validate the server and client certificates. Distribution of the certificate is out of scope for this service.


### Hub Server Certificate 

Hub Services use a CA signed server certificate to identify themselves to clients.

A new Hub server TLS certificate is generated on each restart and signed by the Hub CA. 


### Hub Client Certificate

Hub services and IoT devices authenticate using client certificates that are signed by the Hub CA. 

Hub services use the same client certificate to authenticate themselves with other Hub services,
such as the directory and the Hub message bus. Currently, all services use the same client certificate with full authorization. This client certificate is regenerated on each restart. This implies that Hub services are fully trusted. 

### IoT Device Client Certificate

IoT devices that register themselves with the Hub to publish 'Things' receive a client certificate upon registration. This certificate is unique to the device and signed by the CA. See also the 'idprov' service that implements the idprov protocol for issuing these certificates.

IoT Device certificates authenticate the IoT device and authorize it to publish the Thing Description documents of the things it represents, and allow subscription to messages to update the Thing configuration and status.  The certificate includes the device ID and type to identify it as an IoT Device.

### Certificate Generation

This module generates the following certificates and stores then in the Hub 'certs' folder.

1. The CA certificate and private key is generated on first startup, as a self-signed certificate. The CA certficate is shared with every client and server and is used to verify authenticity of all other certificates. The CA key is only used to generate the certificates listed here. Intermediary certificates are not used by WoST Hub services.
2. The hub certificate and key are regenerated on each startup using the CA certificate. This certificate is used by hub services such as the provisioning server (idprov), directory server (thingdir), and mosquitto message bus server. The keys of this certificate is used to generate and validate access and refresh tokens.
3. The plugin certificate and key are regenerated on each startup using the CA certificate. This client certificate is used by hub services to authenticate access other hub services, like for example the message bus.
4. IoT Device client certificates are generated by the IDProv provisioning server using the client's public key. These certificates include the OU 'things' and are only issued to IoT devices that publish Thing information.

A commandline utility can generate custom certificates for special users such as administrators. All services accept certificates signed by the CA.

### Client Certificate Authentication

Authentication through client certificates is handled by the TLS protocol itself. A valid certificate is required in order to make a connection. The certificate CN contains the user or service name, the OU is used to indicate the role in the organization:

* Hub plugins use the hub client certificate to access other Hub services. The Hub plugin certificate contains 'plugin' as the OU which is used to authorize full access.
* IoT devices have the device-ID as the CN and 'iotdevice' as the OU. IoT devices are publishers of things and have access to all Things of which they are the publisher.
* The administrator certificate has their user loginID as the CN and 'admin' as the OU.
* Other clients have their loginID as the CN and 'client' as the OU.

Properly signed certificates are accepted as valid authentication without the need of additional credentials. Their OU are used in authorization.


## Build and Installation

### Build & Install (tentative)

Run 'make all' to build and 'make install' to install as a user.

See [hub's README.md](https://github.com/wostzone/hub/README.md) for more details on system installation.

## Usage

... todo examples ...

